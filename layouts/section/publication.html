{{ define "main" }}
  <div class="universal-wrapper pt-3">
    <h1>{{ .Title }}</h1>
    <div class="mt-3 mb-3">
      <input id="pub-search" class="form-control" type="search" placeholder="搜索作者、标题、期刊、DOI…" oninput="window.filterPubs && window.filterPubs(this.value)">
    </div>
  </div>

  <div class="universal-wrapper">
    <script>
      window.currentPubCategory = 'all';
      window.currentPubTag = 'all';
      window.filterPubs = (q => {
        window.currentPubQuery = (q || '').toLowerCase();
        const items = document.querySelectorAll('.pub-list-item');
        const activeCat = window.currentPubCategory || 'all';
        const activeTag = window.currentPubTag || 'all';
        items.forEach(el => {
          const text = el.textContent.toLowerCase();
          const cat = (el.getAttribute('data-category') || '').toLowerCase();
          const tagsStr = el.getAttribute('data-tags') || '';
          const tags = tagsStr.split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
          const matchText = text.indexOf(window.currentPubQuery) !== -1;
          const matchCat = (activeCat === 'all') || (cat === activeCat.toLowerCase());
          const matchTag = (activeTag === 'all') || tags.includes(activeTag.toLowerCase());
          el.style.display = (matchText && matchCat && matchTag) ? '' : 'none';
        });

        // Toggle headings visibility
        const headings = document.querySelectorAll('h2[data-category]');
        headings.forEach(h => {
          const hCat = (h.getAttribute('data-category') || '').toLowerCase();
          const matchCatH = (activeCat === 'all') || (hCat === activeCat.toLowerCase());
          // Show heading only if category matches AND there is at least one visible item under it
          if (!matchCatH) {
            h.style.display = 'none';
            return;
          }
          // Find next siblings until next heading to see if any item is visible
          let next = h.nextElementSibling;
          let hasVisible = false;
          while (next && next.tagName !== 'H2') {
            if (next.classList && next.classList.contains('pub-list-item') && next.style.display !== 'none') {
              hasVisible = true;
              break;
            }
            next = next.nextElementSibling;
          }
          h.style.display = hasVisible ? '' : 'none';
        });
      });

      window.setPubCategory = (cat => {
        window.currentPubCategory = cat || 'all';
        const btns = document.querySelectorAll('.pub-cat-btn');
        btns.forEach(b => {
          const bcat = b.getAttribute('data-cat');
          if ((cat === 'all' && bcat === 'all') || (bcat && bcat.toLowerCase() === (cat || 'all').toLowerCase())) {
            b.classList.add('btn-primary');
            b.classList.remove('btn-outline-primary');
          } else {
            b.classList.remove('btn-primary');
            b.classList.add('btn-outline-primary');
          }
        });
        window.filterPubs(window.currentPubQuery || '');
      });

      window.setPubTag = (tag => {
        window.currentPubTag = (tag && tag.toLowerCase()) || 'all';
        const indicator = document.getElementById('pub-tag-indicator');
        const clearBtn = document.getElementById('pub-tag-clear');
        if (window.currentPubTag === 'all') {
          indicator.textContent = '全部';
          if (clearBtn) clearBtn.style.display = 'none';
        } else {
          indicator.textContent = tag;
          if (clearBtn) clearBtn.style.display = '';
        }
        window.filterPubs(window.currentPubQuery || '');
      });
    </script>

    {{/* Category filter buttons */}}
    {{ $items := site.Data.publications }}
    {{ if $items }}
      {{ $items = sort $items "year" "desc" }}
      {{/* Build category list in specified order: 书籍 -> 综述 -> 期刊 -> 会议 */}}
      {{ $orderedCategories := slice "专著/书籍" "综述论文" "期刊论文" "会议论文" }}
      {{ $categories := slice }}
      {{ range $cat := $orderedCategories }}
        {{ $hasItems := false }}
        {{ range $it := $items }}
          {{ if eq $it.category $cat }}
            {{ $hasItems = true }}
            {{ break }}
          {{ end }}
        {{ end }}
        {{ if $hasItems }}
          {{ $categories = $categories | append $cat }}
        {{ end }}
      {{ end }}
      <div class="mb-3">
        <button type="button" class="btn btn-sm btn-primary mr-2 pub-cat-btn" data-cat="all" onclick="window.setPubCategory('all')">全部</button>
        {{ range $categories }}
          <button type="button" class="btn btn-sm btn-outline-primary mr-2 pub-cat-btn" data-cat="{{ . }}" onclick="window.setPubCategory('{{ . }}')">{{ . }}</button>
        {{ end }}
      </div>
      <div class="mb-3">
        <span class="text-muted mr-2">标签筛选:</span>
        <span id="pub-tag-indicator" class="badge badge-secondary mr-2">全部</span>
        <button id="pub-tag-clear" type="button" class="btn btn-sm btn-outline-secondary" style="display:none" onclick="window.setPubTag('all')">清除标签</button>
      </div>
    {{ end }}

    {{ $items := site.Data.publications }}
    {{ if not $items }}
      <p class="text-muted">暂无出版物数据。</p>
    {{ else }}
      {{ $items = sort $items "year" "desc" }}
      {{/* Build category list in specified order: 书籍 -> 综述 -> 期刊 -> 会议 */}}
      {{ $orderedCategories := slice "专著/书籍" "综述论文" "期刊论文" "会议论文" }}
      {{ $categories := slice }}
      {{ range $cat := $orderedCategories }}
        {{ $hasItems := false }}
        {{ range $it := $items }}
          {{ if eq $it.category $cat }}
            {{ $hasItems = true }}
            {{ break }}
          {{ end }}
        {{ end }}
        {{ if $hasItems }}
          {{ $categories = $categories | append $cat }}
        {{ end }}
      {{ end }}
      {{ range $ci, $cat := $categories }}
        {{ $group := where $items "category" $cat }}
        {{ if gt (len $group) 0 }}
          <h2 class="mt-4" data-category="{{ $cat }}">{{ $cat }}</h2>
          {{ $.Scratch.Set "idx" 0 }}
          {{ range $it := $items }}
            {{ if eq $it.category $cat }}
              {{ $.Scratch.Add "idx" 1 }}
              {{ $i := $.Scratch.Get "idx" }}
            {{ $url := $it.url_custom }}
            {{ if not $url }}{{ with $it.doi }}{{ $url = (printf "https://doi.org/%s" .) }}{{ end }}{{ end }}
            {{ if not $url }}{{ with $it.url_pdf }}{{ $url = . }}{{ end }}{{ end }}
            {{ if not $url }}{{ with $it.url_source }}{{ $url = . }}{{ end }}{{ end }}

            {{ $tags := $it.tags }}
            <article class="pub-list-item py-2" data-category="{{ $it.category }}" data-tags="{{ if $tags }}{{ delimit $tags "," }}{{ end }}">
              <p class="mb-1">
                <strong>{{ $i }}.</strong>

                {{ with $it.authors }}
                  {{ $n := len . }}
                  {{ range $j, $a := . }}
                    {{ if eq $j 0 }}{{ $a }}{{ else }}{{ if eq $j (sub $n 1) }}, and {{ $a }}{{ else }}, {{ $a }}{{ end }}{{ end }}
                  {{ end }}.
                {{ end }}

                <a href="{{ $url }}" {{ if and $url (hasPrefix $url "http") }}target="_blank" rel="noopener"{{ end }}>{{ $it.title }}</a>,

                {{ $venue := or $it.publisher $it.publication }}
                {{ if $venue }}{{ $venue }}{{ end }}{{ if and $venue $it.year }} {{ end }}{{ if $it.year }}{{ $it.year }}{{ end }}

                {{ with $it.doi }}, DOI: {{ printf "https://doi.org/%s" . }}{{ end }}.

                {{ with $it.url_code }}<a href="{{ . }}" target="_blank" rel="noopener">[代码]</a>{{ end }} {{ with $it.url_pdf }}<a href="{{ . }}" target="_blank" rel="noopener">[pdf]</a>{{ end }}
                
                <span class="citation-buttons ml-2">
                  <button type="button" class="btn btn-sm btn-outline-secondary citation-btn" 
                          data-pub-id="{{ $i }}" 
                          data-title="{{ $it.title }}"
                          data-authors="{{ if $it.authors }}{{ delimit $it.authors ", " }}{{ end }}"
                          data-publisher="{{ or $it.publisher $it.publication }}"
                          data-year="{{ $it.year }}"
                          data-doi="{{ $it.doi }}"
                          data-venue="{{ or $it.publisher $it.publication }}"
                          data-category="{{ $it.category }}"
                          onclick="showCitationModal(this)">
                    [引用]
                  </button>
                </span>
              </p>
              {{ with $tags }}
              <div class="mb-2">
                {{ range . }}
                  <a href="#" class="badge badge-light mr-1 pub-tag" data-tag="{{ . }}" onclick="window.setPubTag('{{ . }}'); return false;">#{{ . }}</a>
                {{ end }}
              </div>
              {{ end }}
            </article>
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  </div>

  <!-- Citation Modal -->
  <div class="modal fade" id="citationModal" tabindex="-1" role="dialog" aria-labelledby="citationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="citationModalLabel">引用格式</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-4">
              <h6 class="mb-3">GB/T 7714 格式</h6>
              <div class="form-group">
                <textarea id="gb7714Citation" class="form-control" rows="6" readonly></textarea>
              </div>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="copyCitation('gb7714Citation', this)">
                复制 GB/T 7714
              </button>
            </div>
            <div class="col-md-6 mb-4">
              <h6 class="mb-3">BibTeX 格式</h6>
              <div class="form-group">
                <textarea id="bibtexCitation" class="form-control" rows="6" readonly></textarea>
              </div>
              <button type="button" class="btn btn-outline-primary btn-sm" onclick="copyCitation('bibtexCitation', this)">
                复制 BibTeX
              </button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Simple Citation Modal Styles */
    .modal-content {
      border-radius: 8px;
    }

    .modal-body textarea {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.4;
    }

    .btn-outline-primary.copied {
      background-color: #28a745;
      border-color: #28a745;
      color: white;
    }
  </style>

  <script>
    function showCitationModal(button) {
      const data = {
        title: button.getAttribute('data-title'),
        authors: button.getAttribute('data-authors'),
        publisher: button.getAttribute('data-publisher'),
        year: button.getAttribute('data-year'),
        doi: button.getAttribute('data-doi'),
        venue: button.getAttribute('data-venue'),
        category: button.getAttribute('data-category')
      };
      
      // Generate GB/T 7714 citation
      const gb7714Citation = generateGB7714Citation(data);
      document.getElementById('gb7714Citation').value = gb7714Citation;
      
      // Generate BibTeX citation
      const bibtexCitation = generateBibTeXCitation(data);
      document.getElementById('bibtexCitation').value = bibtexCitation;
      
      // Show modal
      const modal = document.getElementById('citationModal');
      if (modal) {
        // Use Bootstrap 5 modal API
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
      }
    }
    
    function generateGB7714Citation(data) {
      let citation = '';
      
      // Authors
      if (data.authors) {
        const authors = data.authors.split(', ');
        if (authors.length === 1) {
          citation += authors[0];
        } else if (authors.length <= 3) {
          citation += authors.join(', ');
        } else {
          citation += authors[0] + ', ' + authors[1] + ', ' + authors[2] + ', 等';
        }
        citation += '. ';
      }
      
      // Title
      if (data.title) {
        citation += data.title + '. ';
      }
      
      // Publication info based on category
      if (data.category === '专著/书籍') {
        if (data.publisher) {
          citation += data.publisher;
        }
        if (data.year) {
          citation += ', ' + data.year;
        }
        citation += '.';
      } else if (data.category === '综述论文' || data.category === '期刊论文') {
        if (data.venue) {
          citation += data.venue;
        }
        if (data.year) {
          citation += ', ' + data.year;
        }
        citation += '.';
      } else if (data.category === '会议论文') {
        if (data.venue) {
          citation += data.venue;
        }
        if (data.year) {
          citation += ', ' + data.year;
        }
        citation += '.';
      }
      
      // DOI
      if (data.doi) {
        citation += ' DOI: ' + data.doi + '.';
      }
      
      return citation;
    }
    
    function generateBibTeXCitation(data) {
      let citation = '';
      let entryType = '';
      let key = '';
      
      // Determine entry type and generate key
      if (data.category === '专著/书籍') {
        entryType = '@book';
        key = generateBibTeXKey(data.authors, data.year);
      } else if (data.category === '综述论文' || data.category === '期刊论文') {
        entryType = '@article';
        key = generateBibTeXKey(data.authors, data.year);
      } else if (data.category === '会议论文') {
        entryType = '@inproceedings';
        key = generateBibTeXKey(data.authors, data.year);
      } else {
        entryType = '@misc';
        key = generateBibTeXKey(data.authors, data.year);
      }
      
      citation += entryType + '{' + key + ',\n';
      
      // Authors
      if (data.authors) {
        citation += '  author = {' + data.authors + '},\n';
      }
      
      // Title
      if (data.title) {
        citation += '  title = {' + data.title + '},\n';
      }
      
      // Publication info based on type
      if (entryType === '@book') {
        if (data.publisher) {
          citation += '  publisher = {' + data.publisher + '},\n';
        }
      } else if (entryType === '@article') {
        if (data.venue) {
          citation += '  journal = {' + data.venue + '},\n';
        }
      } else if (entryType === '@inproceedings') {
        if (data.venue) {
          citation += '  booktitle = {' + data.venue + '},\n';
        }
      }
      
      // Year
      if (data.year) {
        citation += '  year = {' + data.year + '},\n';
      }
      
      // DOI
      if (data.doi) {
        citation += '  doi = {' + data.doi + '},\n';
      }
      
      // Remove trailing comma and newline
      citation = citation.replace(/,\n$/, '\n');
      citation += '}';
      
      return citation;
    }
    
    function generateBibTeXKey(authors, year) {
      if (!authors) return 'unknown' + (year || '');
      const firstAuthor = authors.split(',')[0].trim();
      const lastName = firstAuthor.split(' ').pop();
      return lastName.toLowerCase() + (year || '');
    }
    
    function copyCitation(textareaId, buttonElement) {
      const textarea = document.getElementById(textareaId);
      textarea.select();
      textarea.setSelectionRange(0, 99999); // For mobile devices
      
      try {
        document.execCommand('copy');
        // Show success state
        const originalText = buttonElement.textContent;
        buttonElement.textContent = '已复制!';
        buttonElement.classList.add('copied');
        
        setTimeout(() => {
          buttonElement.textContent = originalText;
          buttonElement.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy text: ', err);
        alert('复制失败，请手动复制文本');
      }
    }
  </script>
{{ end }}



{{ define "main" }}
  <div class="universal-wrapper pt-3">
    <h1>{{ .Title }}</h1>
    <div class="mt-3 mb-3">
      <input id="pub-search" class="form-control" type="search" placeholder="搜索作者、标题、期刊、DOI…" oninput="window.filterPubs && window.filterPubs(this.value)">
    </div>
  </div>

  <div class="universal-wrapper">
    <script>
      window.filterPubs = (q => {
        q = (q || '').toLowerCase();
        const items = document.querySelectorAll('.pub-list-item');
        items.forEach(el => {
          const text = el.textContent.toLowerCase();
          el.style.display = text.indexOf(q) !== -1 ? '' : 'none';
        });
      });
    </script>

    {{ $items := site.Data.publications }}
    {{ if not $items }}
      <p class="text-muted">暂无出版物数据。</p>
    {{ else }}
      {{ $items = sort $items "year" "desc" }}
      {{ $groups := slice (dict "key" "Authored Book" "label" "专著") (dict "key" "Survey Papers" "label" "综述论文") (dict "key" "Journal Papers" "label" "期刊论文") }}
      {{ range $ci, $cat := $groups }}
        {{ $g1 := where $items "category" $cat.key }}
        {{ $g2 := where $items "category" $cat.label }}
        {{ $count := add (len $g1) (len $g2) }}
        {{ if gt $count 0 }}
          <h2 class="mt-4">{{ $cat.label }}</h2>
          {{ $.Scratch.Set "idx" 0 }}
          {{ range $it := $items }}
            {{ if or (eq $it.category $cat.key) (eq $it.category $cat.label) }}
              {{ $.Scratch.Add "idx" 1 }}
              {{ $i := $.Scratch.Get "idx" }}
            {{ $url := $it.url_custom }}
            {{ if not $url }}{{ with $it.doi }}{{ $url = (printf "https://doi.org/%s" .) }}{{ end }}{{ end }}
            {{ if not $url }}{{ with $it.url_pdf }}{{ $url = . }}{{ end }}{{ end }}
            {{ if not $url }}{{ with $it.url_source }}{{ $url = . }}{{ end }}{{ end }}

            <article class="pub-list-item py-2">
              <p class="mb-1">
                <strong>{{ $i }}.</strong>

                {{ with $it.authors }}
                  {{ $n := len . }}
                  {{ range $j, $a := . }}
                    {{ if eq $j 0 }}{{ $a }}{{ else }}{{ if eq $j (sub $n 1) }}, and {{ $a }}{{ else }}, {{ $a }}{{ end }}{{ end }}
                  {{ end }}.
                {{ end }}

                <a href="{{ $url }}" {{ if and $url (hasPrefix $url "http") }}target="_blank" rel="noopener"{{ end }}>{{ $it.title }}</a>,

                {{ $venue := or $it.publisher $it.publication }}
                {{ if $venue }}{{ $venue }}{{ end }}{{ if and $venue $it.year }} {{ end }}{{ if $it.year }}{{ $it.year }}{{ end }}

                {{ with $it.doi }}, DOI: {{ printf "https://doi.org/%s" . }}{{ end }}.

                {{ with $it.url_code }}<a href="{{ . }}" target="_blank" rel="noopener">[代码]</a>{{ end }} {{ with $it.url_pdf }}<a href="{{ . }}" target="_blank" rel="noopener">[pdf]</a>{{ end }}
              </p>
            </article>
            {{ end }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  </div>
{{ end }}


